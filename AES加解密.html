<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AES-128-CBC åŠ è§£å¯†å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .panel { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        textarea { width: 100%; height: 150px; margin: 10px 0; padding: 10px; }
        input { width: 300px; padding: 8px; margin: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        .encrypt-btn { background: #28a745; }
        .decrypt-btn { background: #dc3545; }
        .copy-btn { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” AES-128-CBC åŠ è§£å¯†å·¥å…·</h1>
        
        <!-- åŠ å¯†é¢æ¿ -->
        <div class="panel">
            <h2>ğŸ”’ åŠ å¯†</h2>
            <div>
                <label>æ˜æ–‡:</label><br>
                <textarea id="plaintext" placeholder="è¯·è¾“å…¥è¦åŠ å¯†çš„å†…å®¹"></textarea>
            </div>
            <div>
                <label>å¯†é’¥ (å¯é€‰ï¼Œé»˜è®¤: 123456):</label><br>
                <input type="text" id="encryptKey" value="123456" placeholder="è¾“å…¥åŠ å¯†å¯†é’¥">
            </div>
            <button class="encrypt-btn" onclick="encryptText()">åŠ å¯†</button>
            <button class="copy-btn" onclick="copyResult('ciphertext')">å¤åˆ¶å¯†æ–‡</button>
            <div>
                <label>åŠ å¯†ç»“æœ:</label><br>
                <textarea id="ciphertext" readonly placeholder="åŠ å¯†åçš„ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"></textarea>
            </div>
        </div>

        <!-- è§£å¯†é¢æ¿ -->
        <div class="panel">
            <h2>ğŸ”“ è§£å¯†</h2>
            <div>
                <label>å¯†æ–‡:</label><br>
                <textarea id="decryptCiphertext" placeholder="è¯·è¾“å…¥è¦è§£å¯†çš„å¯†æ–‡"></textarea>
            </div>
            <button class="decrypt-btn" onclick="decryptText()">è§£å¯†</button>
            <button class="copy-btn" onclick="copyResult('decryptResult')">å¤åˆ¶æ˜æ–‡</button>
            <div>
                <label>è§£å¯†ç»“æœ:</label><br>
                <textarea id="decryptResult" readonly placeholder="è§£å¯†åçš„ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ"></textarea>
            </div>
        </div>

        <!-- æ‰¹é‡æµ‹è¯• -->
        <div class="panel">
            <h2>ğŸ§ª æµ‹è¯•åŠŸèƒ½</h2>
            <button onclick="testEncryption()">æµ‹è¯•åŠ å¯†è§£å¯†</button>
            <button onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰</button>
            <div id="testResult"></div>
        </div>
    </div>

    <script>
        // ==================== åŠ å¯†å‡½æ•° ====================
        function encryptText() {
            const plaintext = document.getElementById('plaintext').value;
            const key = document.getElementById('encryptKey').value || '123456';
            
            if (!plaintext) {
                alert('è¯·è¾“å…¥è¦åŠ å¯†çš„å†…å®¹');
                return;
            }

            try {
                // ä½¿ç”¨å½“å‰æ—¶é—´æˆ³ä½œä¸ºIV
                const iv = Date.now().toString();
                
                // åŠ å¯†å¤„ç†
                const encryptedData = encryptAES(plaintext, key, iv);
                
                // æ„å»ºå®Œæ•´å¯†æ–‡æ ¼å¼
                const keyHex = stringToHex(`$#${key}#$`);
                const ivHex = stringToHex(iv);
                const fullCiphertext = keyHex + encryptedData + ivHex;
                
                document.getElementById('ciphertext').value = fullCiphertext;
                document.getElementById('decryptCiphertext').value = fullCiphertext; // è‡ªåŠ¨å¡«å……åˆ°è§£å¯†æ¡†
                
                console.log('åŠ å¯†æˆåŠŸ:', { key, iv, ciphertext: fullCiphertext });
            } catch (error) {
                alert('åŠ å¯†å¤±è´¥: ' + error.message);
                console.error('åŠ å¯†é”™è¯¯:', error);
            }
        }

        // AESåŠ å¯†æ ¸å¿ƒå‡½æ•°
        function encryptAES(plaintext, key, iv) {
            // å¯†é’¥å’ŒIVå¡«å……åˆ°16å­—èŠ‚
            const paddedKey = key.padEnd(16, '0');
            const paddedIv = iv.padEnd(16, '0');
            
            const keyBytes = CryptoJS.enc.Utf8.parse(paddedKey);
            const ivBytes = CryptoJS.enc.Utf8.parse(paddedIv);
            
            // æ‰§è¡ŒAESåŠ å¯†
            const encrypted = CryptoJS.AES.encrypt(plaintext, keyBytes, {
                iv: ivBytes,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            
            return encrypted.ciphertext.toString(CryptoJS.enc.Hex);
        }

        // ==================== è§£å¯†å‡½æ•° ====================
        function decryptText() {
            const ciphertext = document.getElementById('decryptCiphertext').value;
            
            if (!ciphertext) {
                alert('è¯·è¾“å…¥è¦è§£å¯†çš„å¯†æ–‡');
                return;
            }

            try {
                const result = decryptAesBCB(ciphertext);
                document.getElementById('decryptResult').value = result;
                console.log('è§£å¯†æˆåŠŸ:', result);
            } catch (error) {
                document.getElementById('decryptResult').value = 'è§£å¯†å¤±è´¥: ' + error.message;
                console.error('è§£å¯†é”™è¯¯:', error);
            }
        }

        // åŸç½‘ç«™çš„è§£å¯†å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
        function decryptAesBCB(encryptedData) {
            var dataArr = encryptedData.split("");
            var prefixCode = CryptoJS.enc.Utf8.parse("$#").toString();
            var suffixCode = CryptoJS.enc.Utf8.parse("#$").toString();
            var pwdMix = dataArr.splice(0, encryptedData.indexOf(suffixCode) + 4).join("");
            var roundtimeInHax = dataArr.splice(dataArr.length - 26, 26).join("");
            var encryptedText = dataArr.join("");
            var pwdInHax = pwdMix.substring(prefixCode.length, pwdMix.length - suffixCode.length);
            var roundTime = CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Hex.parse(roundtimeInHax));
            var pwd = CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Hex.parse(pwdInHax));
            var iv = CryptoJS.enc.Utf8.parse(roundTime.padEnd(16, "0"));
            var pkBlocks = CryptoJS.enc.Utf8.parse(pwd.padEnd(16, "0"));
            var cipherParams = CryptoJS.lib.CipherParams.create({
                ciphertext: CryptoJS.enc.Hex.parse(encryptedText),
            });
            var decryptedData = CryptoJS.enc.Utf8.stringify(
                CryptoJS.AES.decrypt(cipherParams, pkBlocks, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7,
                })
            );
            return decryptedData;
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        // å­—ç¬¦ä¸²è½¬Hex
        function stringToHex(str) {
            return CryptoJS.enc.Hex.stringify(CryptoJS.enc.Utf8.parse(str));
        }

        // å¤åˆ¶æ–‡æœ¬
        function copyResult(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            document.execCommand('copy');
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        // æµ‹è¯•åŠŸèƒ½
        function testEncryption() {
            const testText = "Hello, è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼";
            const testKey = "123456";
            
            document.getElementById('plaintext').value = testText;
            document.getElementById('encryptKey').value = testKey;
            
            // è‡ªåŠ¨åŠ å¯†
            encryptText();
            
            // ç¨åè‡ªåŠ¨è§£å¯†
            setTimeout(() => {
                decryptText();
                
                const original = testText;
                const decrypted = document.getElementById('decryptResult').value;
                
                const testResult = document.getElementById('testResult');
                if (original === decrypted) {
                    testResult.innerHTML = '<p style="color: green;">âœ… æµ‹è¯•æˆåŠŸï¼åŠ å¯†è§£å¯†åŠŸèƒ½æ­£å¸¸</p>';
                } else {
                    testResult.innerHTML = '<p style="color: red;">âŒ æµ‹è¯•å¤±è´¥ï¼åŠ å¯†è§£å¯†ç»“æœä¸ä¸€è‡´</p>';
                }
            }, 500);
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            document.getElementById('plaintext').value = '';
            document.getElementById('ciphertext').value = '';
            document.getElementById('decryptCiphertext').value = '';
            document.getElementById('decryptResult').value = '';
            document.getElementById('testResult').innerHTML = '';
        }

        // é¡µé¢åŠ è½½åçš„åˆå§‹åŒ–
        window.onload = function() {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›ç¤ºä¾‹æ–‡æœ¬
            document.getElementById('plaintext').placeholder = 'ä¾‹å¦‚: Hello World!\næˆ–è€…: è¿™æ˜¯ä¸€æ®µæµ‹è¯•æ–‡æœ¬';
            document.getElementById('decryptCiphertext').placeholder = 'ä¾‹å¦‚: 24233132333435362324...';
        };
    </script>
</body>
</html>